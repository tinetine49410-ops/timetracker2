<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeTracker — App</title>
  <style>
    :root{--card:#0f1a2c;--border:#1f2b44;--txt:#e5e7eb;--muted:#94a3b8;--green:#10b981;--blue:#2563eb;--red:#ef4444}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;min-height:100vh;background:radial-gradient(1200px 600px at 30% 10%, #0f2345 0%, #05070b 60%, #000 100%);color:var(--txt)}
    .top{display:flex;align-items:center;justify-content:space-between;padding:20px 22px}
    .title{font-weight:900;font-size:20px}
    .logout{background:var(--red);color:#fff;border:none;padding:12px 16px;border-radius:14px;font-weight:900;cursor:pointer}
    .wrap{max-width:980px;margin:0 auto;padding:0 18px 28px}
    .card{margin-top:20px;background:rgba(15,26,44,.92);border:1px solid rgba(31,43,68,.9);border-radius:26px;padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
    h2{margin:0 0 10px}
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 12px}
    .badge{background:rgba(255,255,255,.06);border:1px solid rgba(31,43,68,.9);padding:8px 10px;border-radius:999px;color:var(--txt);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input{flex:1;min-width:240px;padding:14px;border-radius:14px;border:1px solid rgba(31,43,68,.9);background:rgba(255,255,255,.06);color:var(--txt);outline:none;font-weight:800}
    .btn{padding:14px 16px;border:none;border-radius:14px;font-weight:900;cursor:pointer}
    .b1{background:var(--blue);color:#06122a}
    .b2{background:var(--green);color:#062014}
    .msg{margin-top:12px;padding:12px;border-radius:14px;border:1px solid rgba(31,43,68,.9);min-height:44px;display:flex;align-items:center}
    .ok{border-color:rgba(16,185,129,.45)}
    .bad{border-color:rgba(239,68,68,.45)}
    .small{margin-top:10px;font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="top">
    <div class="title">TimeTracker — tableau de bord</div>
    <button id="btnLogout" class="logout">Déconnexion</button>
  </div>

  <div class="wrap">
    <div class="card">
      <h2>Compte</h2>
      <div class="badges">
        <div class="badge" id="bEmail">Email : …</div>
        <div class="badge" id="bUid">User ID : …</div>
      </div>

      <h2>Test sauvegarde (Supabase)</h2>
      <div class="row">
        <input id="hours" inputmode="decimal" placeholder="Heures (ex: 20.75)" />
        <button id="btnLoad" class="btn b1">Charger</button>
        <button id="btnSave" class="btn b2">Sauvegarder</button>
      </div>

      <div id="msg" class="msg">Prêt.</div>
      <div class="small">Table utilisée : <b>timetracker</b> (user_id uuid, hours numeric) — 1 ligne par utilisateur.</div>
    </div>
  </div>

  <!-- ✅ Supabase UMD (pas module) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
    const SUPABASE_URL = "https://nqmfrvargnwgcavmymwh.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_I2iHiULq2tMdZZpEUEKXgg_wer0lyAH";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const TABLE = "timetracker";

    const $ = (id)=>document.getElementById(id);
    const msgEl = $("msg");

    function setMsg(text, type=""){
      msgEl.className = "msg " + (type || "");
      msgEl.textContent = text;
    }

    async function requireSession(){
      const { data } = await sb.auth.getSession();
      if (!data || !data.session) location.href = "./index.html";
      return data.session.user;
    }

    async function init(){
      const user = await requireSession();
      $("bEmail").textContent = "Email : " + (user.email || "—");
      $("bUid").textContent = "User ID : " + user.id;

      $("btnLogout").addEventListener("click", async () => {
        await sb.auth.signOut();
        location.href = "./index.html";
      });

      $("btnLoad").addEventListener("click", async () => {
        try{
          setMsg("Chargement...");
          const { data, error } = await sb
            .from(TABLE)
            .select("hours")
            .eq("user_id", user.id)
            .maybeSingle();

          if (error) return setMsg("❌ " + error.message, "bad");
          $("hours").value = (data?.hours ?? 0);
          setMsg("✅ Chargé.", "ok");
        }catch(e){
          setMsg("❌ " + (e?.message || e), "bad");
        }
      });

      $("btnSave").addEventListener("click", async () => {
        try{
          const raw = ($("hours").value || "").toString().trim().replace(",", ".");
          const hours = Number(raw);
          if (!Number.isFinite(hours)) return setMsg("❌ Valeur heures invalide.", "bad");

          setMsg("Sauvegarde...");
          const { error } = await sb
            .from(TABLE)
            .upsert({ user_id: user.id, hours }, { onConflict: "user_id" });

          if (error) return setMsg("❌ " + error.message, "bad");
          setMsg("✅ Sauvegardé.", "ok");
        }catch(e){
          setMsg("❌ " + (e?.message || e), "bad");
        }
      });

      $("btnLoad").click();
    }

    init();
  </script>
</body>
</html>
