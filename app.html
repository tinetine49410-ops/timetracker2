<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

/* =========================
   CONFIG SUPABASE
========================= */
const SUPABASE_URL = "https://nqmfrvargnwgcavmymwh.supabase.co";
const SUPABASE_KEY = "sb_publishable_I2iHiULq2tMdZZpEUEKXgg_wer0lyAH";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   ELEMENTS
========================= */
const btnStart = document.getElementById("btnStart");
const msg = document.getElementById("startupMsg");

const fullnameEl = document.getElementById("startup_name");
const balanceEl = document.getElementById("startup_balance");
const dateEl = document.getElementById("startup_date");
const contractEl = document.getElementById("startup_contract");

/* =========================
   SESSION
========================= */
const { data: { session } } = await supabase.auth.getSession();
if (!session) location.href = "index.html";
const user = session.user;

/* =========================
   SAVE STARTUP
========================= */
async function startupSave() {
  msg.textContent = "⏳ Sauvegarde…";

  const payload = {
    user_id: user.id,
    fullname: fullnameEl.value.trim(),
    start_balance: Number(balanceEl.value || 0),
    start_date: dateEl.value,
    contract: contractEl.value
  };

  if (!payload.fullname || !payload.start_date) {
    msg.textContent = "❌ Champs obligatoires manquants";
    return;
  }

  const { error } = await supabase
    .from("timetracker_profile")
    .upsert(payload, { onConflict: "user_id" });

  if (error) {
    msg.textContent = "❌ " + error.message;
    return;
  }

  msg.textContent = "✅ Configuration enregistrée";
  setTimeout(() => location.reload(), 600);
}

/* =========================
   BUTTON
========================= */
btnStart.addEventListener("click", startupSave);
</script>
